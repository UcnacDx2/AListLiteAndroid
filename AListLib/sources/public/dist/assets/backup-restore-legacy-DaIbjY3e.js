System.register(["./index-legacy-BzvznpU_.js","./useTitle-legacy-bcKFIeMP.js","./index-legacy-f2eHFB4O.js"],function(e,t){"use strict";var n,r,s,a,o,i,c,d,u,l,g,m,p,f,h,y,b,_,w;return{setters:[e=>{n=e.X,r=e.b7,s=e.bq,a=e.E,o=e.ao,i=e.a8,c=e.q,d=e.bR,u=e.c0,l=e.bE,g=e.bQ,m=e.bo,p=e.a7,f=e.G,h=e.cy,y=e.x,b=e.a6},e=>{_=e.b},e=>{w=e.c}],execute:function(){const t={success:{icon:"✅",color:"$success9"},error:{icon:"❌",color:"$danger9"},info:{icon:"ℹ️",color:"$info9"}},$=e=>a(o,{w:"$full",spacing:"$1",get children(){return[a(b,{get children(){return t[e.type].icon}}),a(b,{get color(){return t[e.type].color},get children(){return e.msg}})]}});e("default",()=>{const[e,t]=n(!1),[b,k]=n(""),v=c();let S;_("manage.sidemenu.backup-restore");const[j,x]=n([]),U=(e,t)=>{x(n=>[...n,{type:t,msg:e}]),S.scrollTop=S.scrollHeight},[E,I]=r(()=>s.get("/admin/setting/list")),[O,R]=r(()=>s.get("/admin/user/list")),[L,T]=r(()=>s.get("/admin/meta/list")),[A,B]=r(()=>s.get("/admin/storage/list")),[J,N]=r(()=>s.get("/share/list"));function C(e,t){if(""==t)return e;const n=w.AES.encrypt(JSON.stringify(e),t).toString();return w.enc.Base64.stringify(w.enc.Utf8.parse(n))}function q(e,t,n,r){if(!r)return e;const s=w.enc.Base64.parse(e).toString(w.enc.Utf8);return n?w.AES.decrypt(s,t).toString(w.enc.Utf8):JSON.parse(w.AES.decrypt(s,t).toString(w.enc.Utf8))}const D=async()=>{U(v("br.start_backup"),"info");const e={encrypted:"",settings:[],users:[],storages:[],metas:[],shares:[]};""!=b()&&(e.encrypted=C("encrypted",b()));for(const t of[{name:"settings",fn:I,page:!1},{name:"users",fn:R,page:!0},{name:"storages",fn:B,page:!0},{name:"metas",fn:T,page:!0},{name:"shares",fn:N,page:!0}]){const n=await t.fn();h(n,n=>{if(U(v("br.success_backup_item",{item:v(`manage.sidemenu.${t.name}`)}),"success"),t.page){for(let e=0;e<n.content.length;e++){const t=n.content[e];for(const e in t)t[e]=C(t[e],b())}e[t.name]=n.content}else{for(let e=0;e<n.length;e++){const t=n[e];for(const e in t)t[e]=C(t[e],b())}e[t.name]=n}},e=>{U(v("br.failed_backup_item",{item:v(`manage.sidemenu.${t.name}`)})+":"+e,"error")})}!function(e,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=e,s.click(),URL.revokeObjectURL(r)}("openlist_backup_"+(new Date).toLocaleString()+".json",e),U(v("br.finish_backup"),"info")},[F,G]=r(e=>s.post("/admin/setting/save",e)),[H,Q]=r(e=>s.post("/admin/user/create",e)),[X,Y]=r(e=>s.post("/admin/storage/create",e)),[z,K]=r(e=>s.post("/admin/meta/create",e)),[M,P]=r(e=>s.post("/share/create",e)),[V,W]=r(e=>s.post("/admin/user/update",e)),[Z,ee]=r(e=>s.post("/admin/storage/update",e)),[te,ne]=r(e=>s.post("/admin/meta/update",e)),[re,se]=r(e=>s.post("/share/update",e));async function ae(e,t,n,r,s,a){const o=(await t()).data.content;for(const i in e){const t=e[i],c=t[s],d="add"==(o.find(e=>e[s]===c)?"update":"add")?n:r;await h(await d(t),()=>{U(v("br.success_restore_item",{item:v(a)})+`-[${c}]`,"success")},e=>{U(v("br.failed_restore_item",{item:v(a)})+`-[${c}]:`+e,"error")})}}return a(p,{spacing:"$2",w:"$full",get children(){return[a(o,{spacing:"$2",w:"$full",get children(){return[a(i,{get loading(){return E()||O()||L()||A()||J()},onClick:()=>{D()},colorScheme:"accent",get children(){return v("br.backup")}}),a(i,{get loading(){return F()||H()||X()||z()||M()||V()||Z()||te()||re()},onClick:()=>{(async()=>{U(v("br.start_restore"),"info");const t=document.createElement("input");t.type="file",t.accept="application/json",t.onchange=async t=>{const n=t.target.files;if(!n||0===n.length)return void y.warning(v("br.no_file"));const r=n[0],s=new FileReader;s.onload=async()=>{const t=JSON.parse(s.result),n=Boolean(t.encrypted);if(n&&'"encrypted"'!==q(t.encrypted,b(),!0,!0))return void U(v("br.wrong_encrypt_password"),"error");const r=Object.values(t);for(let e=r.length-4;e<r.length;e++){const t=r[e];console.log(t);for(let e=0;e<t.length;e++){const r=t[e];for(const e in r)r[e]=q(r[e],b(),!1,n)}}if(e()&&await D(),t.settings&&h(await G(t.settings.filter(e=>!["version","index_progress"].includes(e.key))),()=>{U(v("br.success_restore_item",{item:v("manage.sidemenu.settings")}),"success")},e=>{U(v("br.failed_restore_item",{item:v("manage.sidemenu.settings")})+":"+e,"error")}),e())await ae(t.users,R,Q,W,"username","manage.sidemenu.users"),await ae(t.storages,B,Y,ee,"mount_path","manage.sidemenu.storages"),await ae(t.metas,T,K,ne,"path","manage.sidemenu.metas"),await ae(t.shares,N,P,se,"id","manage.sidemenu.shares");else for(const e of[{name:"users",fn:Q,data:t.users,key:"username",removeId:!0},{name:"storages",fn:Y,data:t.storages,key:"mount_path",removeId:!0},{name:"metas",fn:K,data:t.metas,key:"path",removeId:!0},{name:"shares",fn:P,data:t.shares,key:"id",removeId:!1}])for(const t of e.data||[])e.removeId&&(t.id=0),h(await e.fn(t),()=>{U(v("br.success_restore_item",{item:v(`manage.sidemenu.${e.name}`)})+`-[${t[e.key]}]`,"success")},n=>{U(v("br.failed_restore_item",{item:v(`manage.sidemenu.${e.name}`)})+` [ ${t[e.key]} ] :`+n,"error")});U(v("br.finish_restore"),"info")},s.readAsText(r)},t.click()})()},get children(){return v("br.restore")}})]}}),a(d,{w:"$full",display:"flex",flexDirection:"column",get children(){return a(u,{w:"$full",direction:"column",gap:"$1",get children(){return[a(l,{get children(){return v("br.override")}}),a(g,{id:"restore-override",get checked(){return e()},onChange:e=>t(e.currentTarget.checked)}),a(l,{get children(){return v("br.encrypt_password")}}),a(m,{id:"password",type:"password",get placeholder(){return v("br.encrypt_password_placeholder")},onInput:e=>k(e.currentTarget.value)})]}})}}),a(p,{p:"$2",ref(e){"function"==typeof S?S(e):S=e},w:"$full",alignItems:"start",rounded:"$md",h:"70vh",bg:"$neutral3",overflowY:"auto",spacing:"$1",get children(){return a(f,{get each(){return j()},children:e=>a($,e)})}})]}})})}}});
