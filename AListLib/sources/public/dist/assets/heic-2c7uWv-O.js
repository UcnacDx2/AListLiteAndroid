import{k as x,X as y,e7 as D,U as h,al as I,an as P,ap as k,aV as b,E as f,a2 as H,S as v,a0 as B,q as L,cp as A,ef as F,eg as M}from"./index-Bl5KfUKm.js";var R=k("<div id=heic-container style=position:relative;width:100%;height:75vh;display:flex;justify-content:center;align-items:center;overflow:hidden><canvas style=max-width:100%;max-height:100%;object-fit:contain>");const q=()=>{const _=L();x();const[d,s]=y(!0),[u,o]=y(!1),{libHeifPath:w}=D();let g=h.objs.filter(e=>/\.(heic|heif|avif|vvc|avc|jpeg|jpg)$/i.test(e.name));g.length===0&&(g=[h.obj]);let c,l,r;I(()=>{$()}),P(()=>{c&&l&&(l=null),c=null});const $=async()=>{s(!0),o(!1);try{window.libheif||await j("".concat(w(),"/libheif.js"),"libheif-script");const e=await C("".concat(w(),"/libheif.wasm"));c=window.libheif({wasmBinary:e}),l=new c.HeifDecoder,await E(h.raw_url)}catch(e){console.error("HEIC初始化失败:",e),o(!0),s(!1)}},j=(e,t)=>new Promise((a,n)=>{const i=document.createElement("script");i.src=e,i.id=t,i.onload=()=>a(),i.onerror=()=>n("脚本加载失败: ".concat(e)),document.head.appendChild(i)}),C=async e=>{const t=await fetch(e);if(!t.ok)throw"WASM加载失败: ".concat(e);return await t.arrayBuffer()},E=async e=>{try{s(!0),o(!1);const t=await fetch(e);if(!t.ok)throw"文件获取失败";const a=await t.arrayBuffer(),n=l.decode(a);if(!n||n.length===0)throw"没有可解码的图像";const i=n[0];await S(i),s(!1)}catch(t){console.error("HEIC解码失败:",t),o(!0),s(!1)}},S=e=>new Promise(t=>{if(!r)return t();const a=e.get_width(),n=e.get_height();r.width=a,r.height=n;const i=new ImageData(a,n);e.display(i,p=>{if(!p||!r)return t();const m=r.getContext("2d");if(!m)return t();m.putImageData(p,0,0),t()})});return(()=>{var e=R(),t=e.firstChild,a=r;return typeof a=="function"?M(a,t):r=t,b(e,f(v,{get when(){return d()},get children(){return f(H,{})}}),null),b(e,f(v,{get when(){return u()},get children(){return f(B,{get msg(){return _("preview.failed_load_heic")},h:"75vh"})}}),null),A(n=>F(t,"display",d()||u()?"none":"block")),e})()};export{q as default};
