name: sync_latest_openlist

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # 每小时执行一次

jobs:
  check_and_sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write  # 必须开启此权限才能触发另一个 workflow
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Compare Versions and Trigger Build
        run: |
          # 1. 获取当前仓库版本，加上 || true 防止 grep 匹配不到时直接报错退出
          raw_name=$(curl -sL https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.name // empty')
          CURRENT_OPENLIST_VERSION=$(echo "$raw_name" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "")
          
          # 2. 获取上游官方版本
          LATEST_OPENLIST_VERSION=$(curl -sL https://api.github.com/repos/OpenListTeam/OpenList/releases/latest | jq -r '.tag_name' | sed 's/^v//')

          echo "CURRENT_OPENLIST_VERSION: ${CURRENT_OPENLIST_VERSION:-'NoneFound'}"
          echo "LATEST_OPENLIST_VERSION: ${LATEST_OPENLIST_VERSION}"

          # 3. 如果没找到本地版本，或者是新版本
          if [ -z "$CURRENT_OPENLIST_VERSION" ]; then
              echo "Status: No local release found or tag format mismatch. Triggering build..."
              gh workflow run build_and_release.yml --repo ${{ github.repository }}
          elif [ "$(printf '%s\n%s' "$CURRENT_OPENLIST_VERSION" "$LATEST_OPENLIST_VERSION" | sort -V | head -n1)" != "$LATEST_OPENLIST_VERSION" ]; then
              echo "Status: New version $LATEST_OPENLIST_VERSION detected! (Local: $CURRENT_OPENLIST_VERSION). Triggering build..."
              gh workflow run build_and_release.yml --repo ${{ github.repository }}
          else
              echo "Status: No Need to Update."
          fi
