name: build_and_release

on:
  push:
    branches-ignore: [ '*' ]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.ref, '-auto')"
    permissions:
      contents: write  # å…è®¸æ¨é€ä»£ç ã€æ ‡ç­¾å’Œåˆ›å»º Release
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: 1-CheckoutCode
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2-SetupGoEnv
        uses: actions/setup-go@v4
        with:
          go-version: 1.24.1
          cache-dependency-path: ${{ github.workspace }}/AListLib/go.sum

      - name: 3-SetupJDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 4-GetLatestTag
        id: get_latest_tag
        run: |
          LATEST_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-beta[0-9]+)?(-auto[0-9]+)?$' | head -n 1 || echo "v1.0.0")
          echo "Latest tag: $LATEST_TAG"
          base_version=""
          auto_num=""
          if [[ $LATEST_TAG =~ ^(v[0-9]+\.[0-9]+\.[0-9]+(-beta[0-9]+)?)(-auto([0-9]+))?$ ]]; then
            base_version="${BASH_REMATCH[1]}"
            auto_num="${BASH_REMATCH[4]}"
          else
            base_version="v1.0.0"
          fi
          if [[ -n "$auto_num" ]]; then
            next_auto=$((auto_num + 1))
            NEW_TAG="${base_version}-auto${next_auto}"
          else
            NEW_TAG="${base_version}-auto1"
          fi
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

      - name: 5-UpdateVersionInfo
        run: |
          APP_VERSION=$(echo "${{ env.NEW_TAG }}" | sed 's/^v//')
          echo "APP_VERSION=${APP_VERSION}" >> $GITHUB_ENV
          sed -i "s/versionName \".*\"/versionName \"${APP_VERSION}\"/" app/build.gradle
          LATEST_OPENLIST_VERSION=$(curl -k -sL https://api.github.com/repos/OpenListTeam/OpenList/releases/latest | grep '"tag_name": ".*"' | cut -d'"' -f4 | cut -d'v' -f2)
          echo "LATEST_OPENLIST_VERSION=${LATEST_OPENLIST_VERSION}" >> $GITHUB_ENV
          sed -i "s/\(public static String OPENLIST_VERSION = \"\)\([^\";]*\)\(\";\)/\1${LATEST_OPENLIST_VERSION}\3/" app/src/main/java/com/leohao/android/alistlite/util/Constants.java

      - name: 6-BuildOpenListArtifacts
        run: |
          cd $GITHUB_WORKSPACE/AListLib/scripts
          sh install_alist.sh
          sh install_gomobile.sh
          sh build_aar.sh

      - name: 7-CommitChanges
        run: |
                git config --global user.email "actions@github.com"
                git config --global user.name "GitHub Actions"
                
                # 1. å…ˆæš‚å­˜æ‰€æœ‰æ›´æ”¹
                git add .
                
                # 2. æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„å†…å®¹
                if git diff --cached --quiet; then
                  echo "No changes to commit"
                else
                  git commit -m "Auto Commit: Update version to ${{ env.APP_VERSION }}"
                  
                  # 3. å…³é”®ï¼šæ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹å¹¶å˜åŸº
                  # --autostash å¯ä»¥å¤„ç†æ‹‰å–æ—¶æœ¬åœ°å·²æœ‰ä¿®æ”¹çš„æƒ…å†µ
                  # ä½¿ç”¨ ${{ github.ref_name }} åŠ¨æ€è·å–åˆ†æ”¯åï¼ˆmaster æˆ– mainï¼‰
                  git pull --rebase --autostash origin ${{ github.ref_name }}
                  
                  # 4. æ¨é€
                  git push origin ${{ github.ref_name }}
                fi

      - name: 8-ReplaceBuglyAppID
        run: |
          # å¦‚æœæ²¡æœ‰è®¾ç½® BUGLY_APP_IDï¼Œåˆ™ä½¿ç”¨å ä½ç¬¦ï¼Œé˜²æ­¢ sed æŠ¥é”™
          BUGLY_ID=${{ secrets.BUGLY_APP_ID }}
          sed -i "s/YOUR_BUGLY_APP_ID/${BUGLY_ID:-debug_id}/g" $GITHUB_WORKSPACE/app/src/main/AndroidManifest.xml

      - name: 9-GrantGradlew
        run: chmod +x gradlew

      - name: 10-BuildAPK
        run: ./gradlew assembleRelease -q

      - name: 11-GenerateTemporaryKeystore
        id: generate_ks
        run: |
          # éšæœºç”Ÿæˆä¸€ä¸ªä¸´æ—¶è¯ä¹¦
          keytool -genkey -v -keystore temp.jks -keyalg RSA -keysize 2048 -validity 10000 \
            -alias testkey -storepass 123456 -keypass 123456 \
            -dname "CN=Test, OU=Test, O=Test, L=Test, S=Test, C=CN"
          
          # å°†è¯ä¹¦è½¬ä¸º Base64 å¹¶å­˜å…¥ç¯å¢ƒå˜é‡
          echo "TEMP_SIGNING_KEY=$(base64 -w 0 temp.jks)" >> $GITHUB_ENV

      - name: 12-SignAPK
        uses: ilharp/sign-android-release@v2
        with:
          releaseDir: app/build/outputs/apk/release
          signingKey: ${{ env.TEMP_SIGNING_KEY }}
          keyAlias: testkey
          keyStorePassword: 123456
          keyPassword: 123456
          buildToolsVersion: 30.0.2

      - name: 13-CreateNewTag
        run: |
          if ! git ls-remote --tags origin | grep -q "refs/tags/${{ env.NEW_TAG }}"; then
            git tag ${{ env.NEW_TAG }}
            git push origin ${{ env.NEW_TAG }}
          fi

      - name: 14-CreateNewRelease
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          tag_name: ${{ env.NEW_TAG }}
          name: From OpenList v${{ env.LATEST_OPENLIST_VERSION }}
          body: |
            ğŸš€ ã€è‡ªåŠ¨æ„å»ºã€‘åŒæ­¥ OpenList v${{ env.LATEST_OPENLIST_VERSION }}
            âš ï¸ æœ¬ç‰ˆæœ¬ä½¿ç”¨ä¸´æ—¶è‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦ç­¾åï¼Œä»…ä¾›æµ‹è¯•ã€‚
          files: app/build/outputs/apk/release/*${{ env.NEW_TAG }}-*-release-signed.apk
