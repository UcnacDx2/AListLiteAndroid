name: build_and_release

on:
  push:
    branches-ignore: [ '*' ]
  workflow_dispatch:  # ÊîØÊåÅÊâãÂä®Ëß¶Âèë

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.ref, '-auto')"
    permissions:
      contents: write  # ÂøÖÈ°ªÂºÄÂêØÂÜôÂÖ•ÊùÉÈôê‰ª•Êé®ÈÄÅ Tag Âíå Release
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: 1-CheckoutCode
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2-SetupGoEnv
        uses: actions/setup-go@v4
        with:
          go-version: 1.24.1
          cache-dependency-path: ${{ github.workspace }}/AListLib/go.sum

      - name: 3-SetupJDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 4-GenerateSelfVersion
        id: version_gen
        run: |
          # Ëé∑Âèñ‰∏äÊ∏∏ÂÆòÊñπÊúÄÊñ∞ÁöÑÁâàÊú¨Âè∑ (‰æãÂ¶Ç 4.1.10)
          UPSTREAM_VER=$(curl -sL https://api.github.com/repos/OpenListTeam/OpenList/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          
          # ÁîüÊàêÈöèÊú∫/Êó∂Èó¥Êà≥ÂêéÁºÄ (Ê†ºÂºè: ÊúàÊó•Êó∂ÂàÜÔºå‰æãÂ¶Ç 02041230)
          # ËøôÊ†∑ËÉΩ‰øùËØÅÊØèÊ¨°ÊûÑÂª∫ÁöÑÁâàÊú¨Âè∑ÈÉΩÊòØÈÄíÂ¢û‰∏îÂîØ‰∏ÄÁöÑ
          TIMESTAMP=$(date +%m%d%H%M)
          
          # ÁªÑÂêàÊàêÊñ∞ÁöÑ TAG
          NEW_TAG="v${UPSTREAM_VER}-auto${TIMESTAMP}"
          
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "UPSTREAM_VER=$UPSTREAM_VER" >> $GITHUB_ENV
          echo "ÁîüÊàêÁöÑÁâàÊú¨Ê†áÁ≠æ‰∏∫: $NEW_TAG"

      - name: 5-UpdateVersionInfo
        run: |
          # ÊèêÂèñÁ∫ØÁâàÊú¨Âè∑Êï∞Â≠ó
          APP_VERSION=$(echo "${{ env.NEW_TAG }}" | sed 's/^v//')
          echo "APP_VERSION=${APP_VERSION}" >> $GITHUB_ENV
          
          # Êõ¥Êñ∞ build.gradle
          sed -i "s/versionName \".*\"/versionName \"${APP_VERSION}\"/" app/build.gradle
          
          # Êõ¥Êñ∞ Constants.java ‰∏≠ÁöÑÁâàÊú¨Âè∑
          sed -i "s/\(public static String OPENLIST_VERSION = \"\)\([^\";]*\)\(\";\)/\1${{ env.UPSTREAM_VER }}\3/" app/src/main/java/com/leohao/android/alistlite/util/Constants.java

      - name: 6-BuildOpenListArtifacts
        run: |
          cd $GITHUB_WORKSPACE/AListLib/scripts
          sh install_alist.sh
          sh install_gomobile.sh
          sh build_aar.sh

      - name: 7-CommitChanges
        run: |
          git config --global user.email "github-actions[bot]@github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto update to version ${{ env.APP_VERSION }}"
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: 8-ReplaceBuglyAppID
        run: |
          sed -i 's/YOUR_BUGLY_APP_ID/${{ secrets.BUGLY_APP_ID }}/g' $GITHUB_WORKSPACE/app/src/main/AndroidManifest.xml

      - name: 9-GrantGradlew
        run: chmod +x gradlew

      - name: 10-BuildAPK
        run: ./gradlew assembleRelease -q

      - name: 11-SetupAndroidSDK
        uses: android-actions/setup-android@v3

      - name: 12-SignAPK
        uses: ilharp/sign-android-release@v2
        with:
          releaseDir: app/build/outputs/apk/release
          signingKey: ${{ secrets.ANDROID_SIGNING_KEY }}
          keyAlias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          buildToolsVersion: 30.0.2

      - name: 13-CreateNewTag
        run: |
          git tag ${{ env.NEW_TAG }}
          git push origin ${{ env.NEW_TAG }}

      - name: 14-CreateNewRelease
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          tag_name: ${{ env.NEW_TAG }}
          name: From OpenList v${{ env.UPSTREAM_VER }} (AutoBuild)
          body: |
            üöÄ Ëá™Âä®ÊûÑÂª∫ÂêåÊ≠•
            - ÂêåÊ≠•‰∏äÊ∏∏ÁâàÊú¨: v${{ env.UPSTREAM_VER }}
            - Êú¨Ê¨°ÊûÑÂª∫ÁâàÊú¨: ${{ env.NEW_TAG }}
          files: app/build/outputs/apk/release/*-release-signed.apk
